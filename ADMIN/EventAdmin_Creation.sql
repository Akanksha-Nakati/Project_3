SET SERVEROUTPUT ON;

DECLARE
    v_sid NUMBER;
    v_serial NUMBER;
    v_sql VARCHAR2(100);
BEGIN
    -- Obtaining SID and SERIAL# values --
    SELECT SID, SERIAL# INTO v_sid, v_serial
    FROM V$SESSION
    WHERE USERNAME = 'EVENTADMIN' AND ROWNUM = 1;
    
    -- Kill the session for EVENTADMIN if session is already present --
    v_sql := 'ALTER SYSTEM KILL SESSION ' || '''' || v_sid  || ',' || v_serial || '''';
  
    EXECUTE IMMEDIATE v_sql;
    DBMS_OUTPUT.PUT_LINE('SESSION ALTERED IF EXISTED');
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('No active session found for EVENTADMIN.');
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
END;
/

BEGIN
    FOR I IN (
    WITH DESIRED_USER AS (SELECT 'EVENTADMIN' USERNAME FROM DUAL)
    SELECT DU.USERNAME FROM DESIRED_USER DU JOIN ALL_USERS AU ON DU.USERNAME = AU.USERNAME
    )
LOOP
    DBMS_OUTPUT.PUT_LINE('USER EVENTADMIN EXIST -> DROPPING USER AND CREATING IT BACK.');
    EXECUTE IMMEDIATE 'DROP USER ' || I.USERNAME || ' CASCADE';
END LOOP;
EXCEPTION 
WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('SOMETHING WENT WRONG ' || SQLERRM);
END;
/
 
CREATE USER EVENTADMIN IDENTIFIED BY "Admin123456789";
GRANT CONNECT, RESOURCE, CREATE VIEW, CREATE USER, DROP USER, CREATE ROLE, DROP ANY ROLE TO EVENTADMIN WITH ADMIN OPTION;
GRANT SELECT ON V$SESSION TO EVENTADMIN;
GRANT ALTER USER TO EVENTADMIN;
GRANT DROP ANY TABLE TO EVENTADMIN;
GRANT DROP ANY SEQUENCE TO EVENTADMIN;
GRANT ALTER SYSTEM TO EVENTADMIN;
GRANT execute ON DBMS_LOCK TO EVENTADMIN;
ALTER USER EVENTADMIN QUOTA UNLIMITED ON DATA;
/